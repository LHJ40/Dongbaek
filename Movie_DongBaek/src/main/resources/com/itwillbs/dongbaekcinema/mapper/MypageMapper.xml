<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itwillbs.dongbaekcinema.mapper.MypageMapper">
  
  <!-- 나의 예매내역 조회 -->
  <select id="selectMyTicket" resultType="com.itwillbs.dongbaekcinema.voNew.MyTicketVO">
		SELECT *
			FROM ORDER_MY_TICKET
			WHERE 
				ORDER_MY_TICKET.member_id = #{member_id}
				AND LEFT(order_num, 8) &gt;= SUBDATE(NOW(), INTERVAL 1 MONTH)
			ORDER BY
				order_num DESC
			<if test="startRow != 0 and listLimit != 0"> <!-- 페이지를 0,0으로 두면 나오지 않게 처리 -->
				LIMIT 
					#{startRow}
					, #{listLimit}
			</if>
	</select>
  
  <!-- 나의 멤버십 등급 조회 -->
  <select id="selectMyGrade" resultType="com.itwillbs.dongbaekcinema.voNew.GradeNextVO">
		SELECT
			G.grade_name
			, grade_discount
			, grade_max
			, next_grade_name
			, next_grade_discount
			FROM GRADE_NEXT G
			JOIN MEMBERS M ON G.grade_name = M.grade_name
			WHERE member_id = #{member_id}
  </select>
  
  
  <!-- 나의 개인정보 조회 -->
  <select id="getMyInfoList" resultType="com.itwillbs.dongbaekcinema.vo.MemberVO">
  		SELECT *
  			FROM MEMBERS
  			WHERE member_id = #{member_id}
  </select>
  
  <!-- 나의 문의 내역 조회 -->
  <select id="selectMyInq" resultType="com.itwillbs.dongbaekcinema.vo.CsVO">
 		SELECT *
 			FROM CS
 			WHERE member_id = #{member_id}
  </select>

  <!--  비밀번호  -->
  <select id="selectMyPasswd" resultType="String">
  		SELECT member_pass
  			FROM MEMBERS
  			WHERE member_id = #{member_id}
  </select>

  <!-- 나의 회원정보 수정  -->
  <!-- 변경 가능 항목 : 비밀번호, 휴대폰, 이메일, 좋아하는 장르 -->
  <!--  -->
  <update id="updateMyInfo">
  		UPDATE
  			MEMBERS
  			SET
  				<if test="member_pass neq ''">
  					member_pass = #{member_pass}
  				</if>
  				<if test="member_email neq ''">
  					, member_email = #{member_email}  					
  				</if>
  				<if test="member_like_genre neq ''">
  					, member_like_genre = #{member_like_genre}
  				</if>
  			WHERE member_id = #{member_id}
  </update>
  
	<!-- 회원 탈퇴 -->
	<!-- 상태 변경 : member_status 를 탈퇴로 변경  -->
	<update id="memberwithdrawal">
		UPDATE
			MEMBERS
			SET
				member_status = '탈퇴'
				, member_withdrawl = now()
			WHERE member_id = #{member_id}
	</update>
  
	<!-- 나의 리뷰 조회하기 -->
	<select id="selectMyReview" resultType="com.itwillbs.dongbaekcinema.vo.ReviewVO">
		SELECT
			review_num
			, review_rating
			, review_content
			, review_date
			, R.movie_num
			, M.movie_name_kr
			FROM REVIEWS R
			JOIN MOVIES M ON R.movie_num = M.movie_num
			WHERE member_id = #{member_id}
			LIMIT 5
	</select>
  
</mapper>
